Jscex.Async={};Jscex.Async.CanceledError=function(){};Jscex.Async.CancellationToken=function(){};
Jscex.Async.CancellationToken.prototype={register:function(a){this.isCancellationRequested&&a();if(!this._handlers)this._handlers=[];this._handlers.push(a)},cancel:function(){if(!this.isCancellationRequested){this.isCancellationRequested=!0;var a=this._handlers;delete this._handlers;for(var b=0;b<a.length;b++)try{a[b]()}catch(f){Jscex.log("Cancellation handler threw an error: "+f)}}},throwIfCancellationRequested:function(){if(this.isCancellationRequested)throw new Jscex.Async.CanceledError;}};
Jscex.Async.Task=function(a){this._delegate=a;this._listeners=[];this.status="ready"};
Jscex.Async.Task.prototype={start:function(){if(this.status!="ready")throw Error('Task can only be started in "ready" status.');var a=this;this.status="running";this._delegate.onStart(function(b,f){if(a.status!="running")throw Error('Callback can only be used in "running" status.');if(b=="success")a.result=f,a.status="succeeded";else if(b=="failure")a.error=f,a.status=f instanceof Jscex.Async.CanceledError?"canceled":"failed";else throw Error("Unsupported type: "+b);a._notify()})},_notify:function(){var a=
this._listeners;delete this._listeners;for(var b=0;b<a.length;b++)try{a[b](this)}catch(f){Jscex.log("Task listener threw an error: "+f)}},addListener:function(a){if(!this._listeners)throw Error('Listeners can only be added in "ready" or "running" status.');this._listeners.push(a)}};
(function(){var a=function(){};a.prototype={binder:"$await",Start:function(a,b){return new Jscex.Async.Task({onStart:function(d){b.next(a,function(a,f){if(a=="normal"||a=="return")d("success",f);else if(a=="throw")d("failure",f);else throw Error("Unsupported type: "+a);})}})},Bind:function(a,b){return{next:function(d,e){var c=function(c){if(c.status=="succeeded"){var g;try{g=b.call(d,a.result)}catch(h){e("throw",h);return}g.next(d,e)}else e("throw",a.error)};a.status=="ready"?(a.addListener(c),a.start()):
a.status=="running"?a.addListener(c):c(a)}}}};for(var b in Jscex.builderBase)a.prototype[b]=Jscex.builderBase[b];Jscex.builders.async=new a;a=Jscex.Async;a.sleep=function(a){return new Jscex.Async.Task({onStart:function(b){setTimeout(function(){b("success")},a)}})};a.onEvent=function(a,b){var d="on"+b;return new Jscex.Async.Task({onStart:function(b){a[d]=function(c){a[d]=null;b("success",c)}}})};a.parallel=function(a){return new Jscex.Async.Task({onStart:function(b){for(var d=[],e=0;e<a.length;e++){var c=
a[e];c._p_idx=e;d.push(c)}var i=!1,g=d.length,h=[],j=function(a){if(!i)if(a.status=="failed")i=!0,b("failure",{task:a});else if(a.status=="succeeded")h[a._p_idx]=a.result,g--,g==0&&(i=!0,b("success",h))};for(e=0;e<d.length;e++)switch(c=d[e],c.status){case "failed":case "succeeded":j(c);break;case "running":c.addListener(j);break;case "ready":c.addListener(j),c.start()}}})}})();
